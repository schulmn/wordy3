<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wordy3 Admin - Letter Sequences</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 15px;
    }
    .letter-input {
      font-family: monospace;
      height: 100px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .status-panel {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
    }
    .warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .success-status {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }
    .calendar-day {
      padding: 5px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .has-sequence {
      background-color: #d4edda;
    }
    .no-sequence {
      background-color: #f8d7da;
    }
    .today {
      font-weight: bold;
      border: 2px solid #007bff;
    }
    .timezone-info {
      background-color: #e2f0fd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .edit-btn {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .cancel-btn {
      background-color: #6c757d;
      color: white;
      margin-left: 10px;
    }
    
    /* Game History Styles */
    .section-divider {
      border-top: 2px solid #ddd;
      margin: 40px 0 20px;
      padding-top: 20px;
    }
    
    .game-history-table {
      width: 100%;
      margin-top: 15px;
    }
    
    .game-row {
      cursor: pointer;
    }
    
    .game-row:hover {
      background-color: #f5f5f5;
    }
    
    .game-row.selected {
      background-color: #e2f0fd;
    }
    
    .game-details {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      display: none;
    }
    
    .game-details.visible {
      display: block;
    }
    
    .game-event {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .game-event.valid {
      color: #155724;
    }
    
    .game-event.invalid {
      color: #721c24;
    }
    
    .game-event.drop {
      color: #856404;
    }
    
    .cleanup-button {
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 10px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .no-games {
      padding: 20px;
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }
    
    /* Pagination Styles */
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
    }
    
    .pagination-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 15px;
      cursor: pointer;
    }
    
    .pagination-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .pagination-info {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Wordy3 Admin - Letter Sequences</h1>
  
  <div class="timezone-info">
    All dates are in US Central Time (America/Chicago)
    <div id="current-time"></div>
  </div>
  
  <div class="status-panel">
    <h2>System Status</h2>
    <div id="today-status" class="status-box">
      <h3>Today's Sequence</h3>
      <div id="today-status-content">Loading...</div>
    </div>
    <div id="upcoming-status" class="status-box">
      <h3>Upcoming Days</h3>
      <div id="calendar"></div>
    </div>
  </div>
  
  <div class="container">
    <div>
      <h2 id="form-title">Create New Letter Sequence</h2>
      <form id="letter-form">
        <input type="hidden" id="sequence-id">
        <div class="form-group">
          <label for="date">Date (US Central Time):</label>
          <input type="date" id="date" required>
        </div>
        
        <div class="form-group">
          <label for="letters">Letters (30-100 uppercase letters, no spaces):</label>
          <textarea id="letters" class="letter-input" required></textarea>
          <div>Count: <span id="letter-count">0</span></div>
        </div>
        
        <div class="form-group">
          <button type="submit" id="save-button">Save Letter Sequence</button>
          <button type="button" id="cancel-button" class="cancel-btn" style="display: none;">Cancel</button>
        </div>
      </form>
      <div id="message"></div>
    </div>
    
    <div>
      <h2>Existing Letter Sequences</h2>
      <table id="sequences-table">
        <thead>
          <tr>
            <th>Date (US Central)</th>
            <th>Letters</th>
            <th>Length</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <div class="section-divider"></div>
  
  <div class="container">
    <div>
      <h2>Game History <button id="cleanup-games" class="cleanup-button">Clean Up Old Games Now</button></h2>
      <p>Showing recent games. Games older than 3 days are automatically deleted by MongoDB's TTL index.</p>
      <table id="games-table" class="game-history-table">
        <thead>
          <tr>
            <th>Date/Time</th>
            <th>Player</th>
            <th>Score</th>
            <th>Best Word</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-games" class="no-games" style="display: none;">No recent games found.</div>
      
      <!-- Pagination Controls -->
      <div class="pagination-controls">
        <button id="prev-page" class="pagination-button" disabled>Previous</button>
        <span id="pagination-info" class="pagination-info">Page 1 of 1</span>
        <button id="next-page" class="pagination-button" disabled>Next</button>
      </div>
    </div>
    
    <div id="game-details" class="game-details">
      <h3>Game Details</h3>
      <div id="game-info">
        <p><strong>Player:</strong> <span id="detail-player"></span></p>
        <p><strong>Score:</strong> <span id="detail-score"></span></p>
        <p><strong>Best Word:</strong> <span id="detail-best-word"></span> (<span id="detail-best-word-score"></span> points)</p>
        <p><strong>Played At:</strong> <span id="detail-played-at"></span></p>
      </div>
      <h4>Game Events</h4>
      <div id="game-events"></div>
      <div id="game-stats">
        <p><strong>Valid Points:</strong> <span id="detail-valid-points"></span></p>
        <p><strong>Invalid Points:</strong> <span id="detail-invalid-points"></span></p>
        <p><strong>Drop Points:</strong> <span id="detail-drop-points"></span></p>
      </div>
    </div>
  </div>

  <script>
    // Update current time in US Central Time
    function updateCurrentTime() {
      const now = new Date();
      const options = { 
        timeZone: 'America/Chicago',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZoneName: 'short'
      };
      
      document.getElementById('current-time').textContent = 
        `Current time: ${now.toLocaleString('en-US', options)}`;
    }
    
    // Update time every second
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Debug function to show date information
    function debugDate(label, date) {
      console.log(`${label}:`, {
        date: date,
        isoString: date.toISOString(),
        localString: date.toString(),
        centralString: date.toLocaleString('en-US', { timeZone: 'America/Chicago' }),
        utcString: new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate())).toISOString()
      });
    }
    
    // Normalize a date to midnight in Central Time
    function normalizeToCentralTime(date = new Date()) {
      // Debug the input date
      let inputDate = date instanceof Date ? date : new Date(date);
      debugDate('Input date', inputDate);
      
      // Get the current date in Central Time
      const centralTime = new Date(inputDate.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
      debugDate('Central time', centralTime);
      
      // Extract year, month, day components from the Central Time date
      const year = centralTime.getFullYear();
      const month = centralTime.getMonth(); // 0-indexed
      const day = centralTime.getDate();
      
      // Create a new date with these components, setting time to midnight
      // We use the local time zone to avoid UTC conversion issues
      const normalizedDate = new Date(year, month, day, 0, 0, 0, 0);
      debugDate('Normalized date', normalizedDate);
      
      return normalizedDate;
    }
    
    // Get tomorrow's date in Central Time
    function getTomorrowCentralTime() {
      const now = new Date();
      debugDate('Current date', now);
      
      const today = normalizeToCentralTime(now);
      debugDate('Today normalized', today);
      
      // Add one day
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      debugDate('Tomorrow', tomorrow);
      
      return tomorrow;
    }
    
    // Format date for input field (YYYY-MM-DD)
    function formatDateForInput(date) {
      // First normalize to Central Time to ensure correct date
      const normalizedDate = normalizeToCentralTime(date);
      debugDate('Date for input', normalizedDate);
      
      const year = normalizedDate.getFullYear();
      const month = String(normalizedDate.getMonth() + 1).padStart(2, '0');
      const day = String(normalizedDate.getDate()).padStart(2, '0');
      
      const formatted = `${year}-${month}-${day}`;
      console.log('Formatted date for input:', formatted);
      return formatted;
    }
    
    // Set default date
    const tomorrow = getTomorrowCentralTime();
    document.getElementById('date').valueAsDate = tomorrow;

    // Update letter count
    document.getElementById('letters').addEventListener('input', function() {
      const letters = this.value.toUpperCase().replace(/[^A-Z]/g, '');
      document.getElementById('letter-count').textContent = letters.length;
    });
    
    // Reset form to create mode
    function resetForm() {
      document.getElementById('form-title').textContent = 'Create New Letter Sequence';
      document.getElementById('sequence-id').value = '';
      document.getElementById('date').valueAsDate = getTomorrowCentralTime();
      document.getElementById('letters').value = '';
      document.getElementById('letter-count').textContent = '0';
      document.getElementById('save-button').textContent = 'Save Letter Sequence';
      document.getElementById('cancel-button').style.display = 'none';
      document.getElementById('message').textContent = '';
      document.getElementById('message').className = '';
    }
    
    // Cancel button handler
    document.getElementById('cancel-button').addEventListener('click', function() {
      resetForm();
    });

    // Form submission
    document.getElementById('letter-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('message');
      const sequenceId = document.getElementById('sequence-id').value;
      const isEdit = sequenceId !== '';
      
      try {
        const date = document.getElementById('date').value;
        const letters = document.getElementById('letters').value.toUpperCase().replace(/[^A-Z]/g, '').split('');
        
        if (letters.length < 30 || letters.length > 100) {
          throw new Error('Letter sequence must contain between 30 and 100 letters');
        }
        
        let url = '/api/letters';
        let method = 'POST';
        
        if (isEdit) {
          url = `/api/letters/${sequenceId}`;
          method = 'PUT';
        }
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ date, letters })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `Failed to ${isEdit ? 'update' : 'create'} letter sequence`);
        }
        
        messageDiv.className = 'success';
        messageDiv.textContent = `Letter sequence ${isEdit ? 'updated' : 'created'} successfully!`;
        
        // Reset form if it was a create operation
        if (!isEdit) {
          resetForm();
        }
        
        // Refresh the table and status
        loadSequences();
        checkTodayStatus();
        createCalendar();
      } catch (error) {
        messageDiv.className = 'error';
        messageDiv.textContent = error.message;
      }
    });
    
    // Edit sequence
    async function editSequence(id) {
      try {
        const response = await fetch(`/api/letters/${id}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to retrieve sequence');
        }
        
        const sequence = data.sequence;
        
        // Update form
        document.getElementById('form-title').textContent = 'Edit Letter Sequence';
        document.getElementById('sequence-id').value = sequence._id;
        document.getElementById('date').value = formatDateForInput(sequence.date);
        document.getElementById('letters').value = sequence.letters.join('');
        document.getElementById('letter-count').textContent = sequence.letters.length;
        document.getElementById('save-button').textContent = 'Update Letter Sequence';
        document.getElementById('cancel-button').style.display = 'inline-block';
        
        // Scroll to form
        document.getElementById('form-title').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error editing sequence:', error);
        alert('Failed to load sequence for editing: ' + error.message);
      }
    }
    
    // Delete sequence
    async function deleteSequence(id) {
      if (!confirm('Are you sure you want to delete this letter sequence?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/letters/${id}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to delete sequence');
        }
        
        // Refresh the table and status
        loadSequences();
        checkTodayStatus();
        createCalendar();
        
        alert('Letter sequence deleted successfully');
      } catch (error) {
        console.error('Error deleting sequence:', error);
        alert('Failed to delete sequence: ' + error.message);
      }
    }

    // Load existing sequences
    async function loadSequences() {
      try {
        const response = await fetch('/api/letters');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to load sequences');
        }
        
        const tbody = document.querySelector('#sequences-table tbody');
        tbody.innerHTML = '';
        
        data.sequences.forEach(sequence => {
          const row = document.createElement('tr');
          
          const dateCell = document.createElement('td');
          // Use our normalizeToCentralTime function to ensure consistent date handling
          const normalizedDate = normalizeToCentralTime(sequence.date);
          console.log('Sequence date for table:', sequence._id, normalizedDate);
          
          // Format the date for display
          dateCell.textContent = normalizedDate.toLocaleDateString('en-US', {
            timeZone: 'America/Chicago',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
          
          // Add a debug attribute to help troubleshoot
          dateCell.setAttribute('data-date', formatDateForInput(normalizedDate));
          
          const lettersCell = document.createElement('td');
          lettersCell.textContent = sequence.letters.join('').substring(0, 30) + '...';
          lettersCell.title = sequence.letters.join('');
          
          const lengthCell = document.createElement('td');
          lengthCell.textContent = sequence.letters.length;
          
          const createdAtCell = document.createElement('td');
          createdAtCell.textContent = new Date(sequence.createdAt).toLocaleString();
          
          const updatedAtCell = document.createElement('td');
          updatedAtCell.textContent = new Date(sequence.updatedAt).toLocaleString();
          
          const actionsCell = document.createElement('td');
          actionsCell.className = 'action-buttons';
          
          const editButton = document.createElement('button');
          editButton.className = 'edit-btn';
          editButton.textContent = 'Edit';
          editButton.onclick = () => editSequence(sequence._id);
          
          const deleteButton = document.createElement('button');
          deleteButton.className = 'delete-btn';
          deleteButton.textContent = 'Delete';
          deleteButton.onclick = () => deleteSequence(sequence._id);
          
          actionsCell.appendChild(editButton);
          actionsCell.appendChild(deleteButton);
          
          row.appendChild(dateCell);
          row.appendChild(lettersCell);
          row.appendChild(lengthCell);
          row.appendChild(createdAtCell);
          row.appendChild(updatedAtCell);
          row.appendChild(actionsCell);
          
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading sequences:', error);
      }
    }

    // Check today's status
    async function checkTodayStatus() {
      const todayStatusContent = document.getElementById('today-status-content');
      
      try {
        const response = await fetch('/api/letters/today');
        
        if (response.ok) {
          const data = await response.json();
          
          // Get today's date in Central Time for display
          const today = normalizeToCentralTime();
          const todayFormatted = today.toLocaleDateString('en-US', {
            timeZone: 'America/Chicago',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
          
          todayStatusContent.innerHTML = `
            <div class="success-status">
              <strong>Sequence available for today (${todayFormatted})!</strong><br>
              Letters: ${data.letters.join('').substring(0, 30)}...<br>
              Total: ${data.letters.length} letters
            </div>
          `;
        } else {
          todayStatusContent.innerHTML = `
            <div class="warning">
              <strong>Warning: No letter sequence available for today!</strong><br>
              The game will not start until a sequence is created.
            </div>
          `;
        }
      } catch (error) {
        todayStatusContent.innerHTML = `
          <div class="warning">
            <strong>Error checking today's sequence:</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    // Create calendar view
    async function createCalendar() {
      const calendarDiv = document.getElementById('calendar');
      calendarDiv.innerHTML = '';
      
      // Get all sequences
      const response = await fetch('/api/letters');
      const data = await response.json();
      const sequences = data.sequences || [];
      
      // Create a map of dates with sequences
      const sequenceDates = new Map();
      sequences.forEach(seq => {
        // Normalize the date to ensure consistent comparison
        const date = normalizeToCentralTime(seq.date);
        const dateString = formatDateForInput(date);
        console.log('Sequence date:', dateString, 'ID:', seq._id);
        sequenceDates.set(dateString, {
          id: seq._id,
          letters: seq.letters
        });
      });
      
      // Generate calendar for next 14 days
      const today = normalizeToCentralTime();
      console.log('Today for calendar:', formatDateForInput(today));
      
      for (let i = 0; i < 14; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() + i);
        const dateString = formatDateForInput(date);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        if (i === 0) dayDiv.classList.add('today');
        
        if (sequenceDates.has(dateString)) {
          dayDiv.classList.add('has-sequence');
          // Make the calendar day clickable to edit the sequence
          dayDiv.style.cursor = 'pointer';
          dayDiv.addEventListener('click', () => {
            const sequenceInfo = sequenceDates.get(dateString);
            editSequence(sequenceInfo.id);
          });
        } else {
          dayDiv.classList.add('no-sequence');
          // Make the calendar day clickable to create a sequence for this date
          dayDiv.style.cursor = 'pointer';
          dayDiv.addEventListener('click', () => {
            // Set the date in the form
            document.getElementById('date').value = dateString;
            // Focus on the letters input
            document.getElementById('letters').focus();
          });
        }
        
        // Display the date in Central Time
        const displayDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
        
        dayDiv.innerHTML = `
          ${displayDate.getDate()}<br>
          <small>${displayDate.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'America/Chicago' })}</small>
        `;
        
        // Add a debug attribute to help troubleshoot
        dayDiv.setAttribute('data-date', dateString);
        
        calendarDiv.appendChild(dayDiv);
      }
    }

    // Run on page load
    loadSequences();
    checkTodayStatus();
    createCalendar();
    
    // Refresh status every minute
    setInterval(() => {
      checkTodayStatus();
      createCalendar();
      updateCurrentTime();
    }, 60000);
    
    // Game History Functions
    
    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 20;
    
    // Load games with pagination
    async function loadGames(page = 1) {
      try {
        // Update current page
        currentPage = page;
        
        // Show loading state
        const tbody = document.querySelector('#games-table tbody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading games...</td></tr>';
        
        // Fetch games with pagination
        const response = await fetch(`/api/games?page=${page}&limit=${pageSize}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to load games');
        }
        
        // Clear the table
        tbody.innerHTML = '';
        
        const noGamesDiv = document.getElementById('no-games');
        
        // Update pagination info
        if (data.pagination) {
          totalPages = data.pagination.totalPages;
          updatePaginationControls(data.pagination);
        }
        
        if (data.games.length === 0) {
          noGamesDiv.style.display = 'block';
          return;
        }
        
        noGamesDiv.style.display = 'none';
        
        data.games.forEach(game => {
          const row = document.createElement('tr');
          row.className = 'game-row';
          row.dataset.gameId = game.gameId;
          
          const dateCell = document.createElement('td');
          const playedAt = new Date(game.playedAt);
          dateCell.textContent = playedAt.toLocaleString();
          
          const playerCell = document.createElement('td');
          playerCell.textContent = game.playerInitials;
          
          const scoreCell = document.createElement('td');
          scoreCell.textContent = game.score;
          
          const bestWordCell = document.createElement('td');
          bestWordCell.textContent = game.bestWord && game.bestWord.word ? 
            `${game.bestWord.word} (${game.bestWord.score})` : 
            'None';
          
          row.appendChild(dateCell);
          row.appendChild(playerCell);
          row.appendChild(scoreCell);
          row.appendChild(bestWordCell);
          
          // Add click event to show game details
          row.addEventListener('click', () => {
            // Remove selected class from all rows
            document.querySelectorAll('.game-row').forEach(r => {
              r.classList.remove('selected');
            });
            
            // Add selected class to clicked row
            row.classList.add('selected');
            
            // Load and show game details
            loadGameDetails(game.gameId);
          });
          
          tbody.appendChild(row);
        });
        
        // Select the first game by default if available
        if (data.games.length > 0) {
          const firstRow = document.querySelector('.game-row');
          firstRow.classList.add('selected');
          loadGameDetails(data.games[0].gameId);
        } else {
          // Hide game details if no games
          document.getElementById('game-details').classList.remove('visible');
        }
      } catch (error) {
        console.error('Error loading games:', error);
        document.getElementById('no-games').style.display = 'block';
        document.getElementById('no-games').textContent = 'Error loading games: ' + error.message;
      }
    }
    
    // Update pagination controls
    function updatePaginationControls(pagination) {
      const prevButton = document.getElementById('prev-page');
      const nextButton = document.getElementById('next-page');
      const paginationInfo = document.getElementById('pagination-info');
      
      // Update pagination info text
      paginationInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages} (${pagination.totalGames} games)`;
      
      // Update button states
      prevButton.disabled = !pagination.hasPrevPage;
      nextButton.disabled = !pagination.hasNextPage;
    }
    
    // Add event listeners for pagination buttons
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        loadGames(currentPage - 1);
      }
    });
    
    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPage < totalPages) {
        loadGames(currentPage + 1);
      }
    });
    
    // Load game details
    async function loadGameDetails(gameId) {
      try {
        const response = await fetch(`/api/games/${gameId}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to load game details');
        }
        
        const game = data.game;
        
        // Update game info
        document.getElementById('detail-player').textContent = game.playerInitials;
        document.getElementById('detail-score').textContent = game.score;
        document.getElementById('detail-best-word').textContent = game.bestWord && game.bestWord.word ? game.bestWord.word : 'None';
        document.getElementById('detail-best-word-score').textContent = game.bestWord ? game.bestWord.score : '0';
        document.getElementById('detail-played-at').textContent = new Date(game.playedAt).toLocaleString();
        
        // Update game events
        const eventsDiv = document.getElementById('game-events');
        eventsDiv.innerHTML = '';
        
        if (game.history && game.history.events) {
          game.history.events.forEach((event, index) => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `game-event ${event.type}`;
            
            let eventText = '';
            
            switch (event.type) {
              case 'valid':
                eventText = `${index + 1}. ✓ ${event.details.word}: ${event.details.basePoints} × ${event.details.lengthMultiplier} × ${event.details.streakMultiplier} = ${event.details.finalPoints}`;
                break;
              case 'invalid':
                eventText = `${index + 1}. ✗ ${event.details.word}: Invalid (-${Math.abs(event.details.points)})`;
                break;
              case 'drop':
                eventText = `${index + 1}. ↓ ${event.details.letter}(-${Math.abs(event.details.points)})`;
                break;
            }
            
            eventDiv.textContent = eventText;
            eventsDiv.appendChild(eventDiv);
          });
        } else {
          eventsDiv.textContent = 'No game events found.';
        }
        
        // Update game stats
        document.getElementById('detail-valid-points').textContent = game.history ? game.history.validPoints : '0';
        document.getElementById('detail-invalid-points').textContent = game.history ? game.history.invalidPoints : '0';
        document.getElementById('detail-drop-points').textContent = game.history ? game.history.dropPoints : '0';
        
        // Show game details
        document.getElementById('game-details').classList.add('visible');
      } catch (error) {
        console.error('Error loading game details:', error);
        document.getElementById('game-details').classList.remove('visible');
        alert('Error loading game details: ' + error.message);
      }
    }
    
    // Clean up old games
    async function cleanupOldGames() {
      try {
        const response = await fetch('/api/games/cleanup', {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to clean up old games');
        }
        
        alert(`Successfully cleaned up ${data.deletedCount} old games`);
        
        // Refresh games list
        loadGames();
      } catch (error) {
        console.error('Error cleaning up old games:', error);
        alert('Error cleaning up old games: ' + error.message);
      }
    }
    
    // Add event listener for cleanup button
    document.getElementById('cleanup-games').addEventListener('click', cleanupOldGames);
    
    // Load games on page load
    loadGames();
  </script>
</body>
</html>
